% XHTML, prefix: xhtm

\parskip0pt


% We do a lot of redefining

\msg_redirect_module:nnn { LaTeX / xparse } { info }    { none }
\msg_redirect_module:nnn { LaTeX / xparse } { warning } { none }

% Sets the top level for sections (and other headings)
\int_new:N \l__xhtm_sec_int
\int_set:Nn \l__xhtm_sec_int {1}

% Define the options for the xhtml module
\keys_define:nn {xhtml options}
{
  section~ level .int_set:N = \l__xhtm_sec_int
}

% Get and set the options for the xhtml module
\prop_get:NnNT  \l__txt_popts_prop {xhtml} \l_tmpa_tl
{
  \keys_set:nV {xhtml options} \l_tmpa_tl
}

% Interface to LaTeX2e conditionals from @egreg at
% http://tex.stackexchange.com/a/119826/86

\prg_new_conditional:Npnn \latex_if:n #1 {p,T,F,TF}
 {
  \use:c{if#1} \prg_return_true: \else: \prg_return_false: \fi:
 }

% Hyperref options
\PassOptionsToPackage{customdriver=hxhtml}{hyperref}
\PassOptionsToPackage{pageanchor=false}{hyperref}
\PassOptionsToPackage{raiselinks=false}{hyperref}
\PassOptionsToPackage{localanchorname=true}{hyperref}

\tl_new:N \l__xhtm_anchor_tl
\tl_new:N \l__xhtm_idtype_tl
\tl_new:N \l__xhtm_nextid_tl
\tl_new:N \l__xhtm_baseurl_tl
\tl_set:Nn \l__xhtm_anchor_tl {plain}
\tl_set:Nn \l__xhtm_idtype_tl {name}

% Tags
\seq_new:N \l__xhtm_tag_seq

\cs_new:Npn \xhtm_push_tag:n #1
{
  \seq_set_split:Nnn \l__txt_args_seq {,} {{#1}}
  \txt_use_hook:nn {xhtm} {pre push tag}
  \seq_gpush:Nn \l__xhtm_tag_seq {#1}
}
\cs_generate_variant:Nn \xhtm_push_tag:n {V}


\msg_new:nnnn {XHTML} {no~ tag} {No~ tag~ available~ to~ close~ '#1'~ at~ line~ \msg_line_context:} {}
\msg_new:nnnn {XHTML} {wrong~ tag} {Tried~ to~ close~ tag~ '#1'~ with~  '#2'~ at~ line~ \msg_line_context:} {}
\cs_generate_variant:Nn \msg_warning:nnnn {nnVn}
\cs_new:Npn \xhtm_pop_tag:n #1
{
  \seq_set_split:Nnn \l__txt_args_seq {,} {{#1}}
  \txt_use_hook:nn {xhtm} {pre pop tag}
  \seq_get:NNTF \l__xhtm_tag_seq \l_tmpa_tl
  {
    \tl_if_eq:VnTF \l_tmpa_tl {#1}
    {
      \seq_gpop:NN \l__xhtm_tag_seq \l_tmpa_tl
    }
    {
      \msg_warning:nnVn {XHTML} {wrong~ tag} \l_tmpa_tl {#1}
    }
  }
  {
    \msg_warning:nnn {XHTML} {no~ tag} {#1}
  }
}

\cs_set_eq:NN \xhtm_mbox:n \mbox

\cs_new_protected_nopar:Npn \xhtm_open_tag:nn #1#2
{
  \seq_set_split:Nnn \l__txt_args_seq {,} {{#1},{#2}}
  \txt_use_hook:nn {xhtm} {pre open tag}
  \xhtm_mbox:n {}
  \xhtm_push_tag:n {#1}
  <#1
  \tl_if_empty:nF{#2}
  {
    \c_space_token
    #2
  }
  >
}
\cs_generate_variant:Nn \xhtm_open_tag:nn {x,V,xx,nx,nV}

\cs_new_protected_nopar:Npn \xhtm_close_tag:n #1
{
  \seq_set_split:Nnn \l__txt_args_seq {,} {{#1}}
  \txt_use_hook:nn {xhtm} {pre close tag}
  \xhtm_pop_tag:n {#1}
  </#1>
}
\cs_generate_variant:Nn \xhtm_close_tag:n {x,V}

\cs_new_protected_nopar:Npn \xhtm_empty_tag:nn #1#2
{
  \xhtm_mbox:n {}
  <#1
  \tl_if_empty:nF{#2}
  {
    \c_space_token
    #2
  }
  />
}

\cs_generate_variant:Nn \xhtm_empty_tag:nn {nx}

\prg_new_protected_conditional:Npnn \xhtm_if_current_tag_is:n #1 {T,F,TF}
{
  \seq_get:NNTF \l__xhtm_tag_seq \l_tmpa_tl
  {
    \tl_if_eq:VnTF \l_tmpa_tl {#1}
    {
      \prg_return_true:
    }
    {
      \prg_return_false:
    }
  }
  {
    \prg_return_false:
  }
}

\prg_new_protected_conditional:Npnn \xhtm_if_current_tag_is_par: {T,F,TF}
{
  \seq_get:NNTF \l__xhtm_tag_seq \l_tmpa_tl
  {
    \tl_if_eq:VnTF \l_tmpa_tl {p}
    {
      \prg_return_true:
    }
    {
      \prg_return_false:
    }
  }
  {
    \prg_return_false:
  }
}

\RenewDocumentCommand \emph {m}
{
  \xhtm_open_tag:nn {em} {}
  #1
  \xhtm_close_tag:n {em}
}

\RenewDocumentCommand \textit {m}
{
  \xhtm_open_tag:nn {em} {}
  #1
  \xhtm_close_tag:n {em}
}

\RenewDocumentCommand \textsc {m}
{
  \xhtm_open_tag:nn {span} {style="font-variant: small-caps;"}
  #1
  \xhtm_close_tag:n {span}
}

\RenewDocumentCommand \textup {m}
{
  \xhtm_open_tag:nn {span} {style="font-style: normal;"}
  #1
  \xhtm_close_tag:n {span}
}

\RenewDocumentCommand \textbf {m}
{
  \xhtm_open_tag:nn {strong} {}
  #1
  \xhtm_close_tag:n {strong}
}

% Highly experimental ...

\tl_new:N \l__xhtm_closebf_tl
\tl_set:Nn \l__xhtm_closebf_tl {\xhtm_close_tag:n {strong}}
\NewDocumentCommand \bf {}
{
  \xhtm_open_tag:nn {strong} {}
  \group_insert_after:N \l__xhtm_closebf_tl
}

\tl_new:N \l__xhtm_closeem_tl
\tl_set:Nn \l__xhtm_closeem_tl {\xhtm_close_tag:n {em}}

\RenewDocumentCommand \em {}
{
  \xhtm_open_tag:nn {em} {}
  \group_insert_after:N \l__xhtm_closeem_tl
}

% Section commands

% If the class defines a `\chapter` and/or `\part` command, we need to
% do so also.  Otherwise, all the section commands step up one on the
% level

\clist_if_in:nVTF {book} \l__txt_class_tl
{
  \newcounter{part}
  \renewcommand\thepart{\@arabic\c@part}
  \NewDocumentCommand \part {s m}
  {
    \IfBooleanTF {#1}
    {
      \xhtm_section:nn {0}{#2}
    }
    {
      \xhtm_num_section:nnn {part} {0}{#2}
    }
  }
}
{
  \int_decr:N \l__xhtm_sec_int
}

\clist_if_in:nVTF {report,book} \l__txt_class_tl
{
  \newcounter{chapter}
  \renewcommand\thechapter{\@arabic\c@chapter}
  \newcounter{section}[chapter]
  \renewcommand\thesection{\thechapter.\@arabic\c@section}
  \NewDocumentCommand \chapter {s m}
  {
    \IfBooleanTF {#1}
    {
      \xhtm_section:nn {1}{#2}
    }
    {
      \xhtm_num_section:nnn {chapter} {1}{#2}
    }
  }
}
{
  \int_decr:N \l__xhtm_sec_int
  \newcounter{section}
  \renewcommand\thesection{\@arabic\c@section}
}

\newcounter{subsection}[section]
\newcounter{subsubsection}[subsection]
\newcounter{paragraph}[subsubsection]
\newcounter{subparagraph}[paragraph]
\renewcommand\thesubsection{\thesection.\@arabic\c@subsection}

\NewDocumentCommand \section {s m}
{
  \IfBooleanTF {#1}
  {
    \xhtm_section:nn {2}{#2}
  }
  {
    \xhtm_num_section:nnn {section} {2}{#2}
  }
}

\NewDocumentCommand \subsection {s m}
{
  \IfBooleanTF {#1}
  {
    \xhtm_section:nn {3}{#2}
  }
  {
    \xhtm_num_section:nnn {subsection} {3}{#2}
  }
}

\NewDocumentCommand \subsubsection {s m}
{
  \IfBooleanTF {#1}
  {
    \xhtm_section:nn {4}{#2}
  }
  {
    \xhtm_num_section:nnn {subsubsection} {4}{#2}
  }
}

\NewDocumentCommand \paragraph {s m}
{
  \IfBooleanTF {#1}
  {
    \xhtm_section:nn {5}{#2}
  }
  {
    \xhtm_num_section:nnn {paragraph} {5}{#2}
  }
}

\NewDocumentCommand \subparagraph {s m}
{
  \IfBooleanTF {#1}
  {
    \xhtm_section:nn {6}{#2}
  }
  {
    \xhtm_num_section:nnn {subparagraph} {6}{#2}
  }
}

\cs_new_nopar:Npn \xhtm_section:nn #1#2
{
  \xhtm_close_par:
  \txt_newline:
  \xhtm_section_header:nnn {#1}{#2}{}
  \txt_newline:
  \xhtm_open_par:
}

\cs_new_nopar:Npn \xhtm_section_header:nnn #1#2#3
{
  \seq_set_split:Nnn \l__txt_args_seq {,} {{#1},{#2},{#3}}
  \txt_use_hook:nn {xhtm} {pre section header}
  \xhtm_open_tag:xn {h \int_eval:n {\l__xhtm_sec_int + #1}}{#3}
  #2
  \xhtm_close_tag:x {h \int_eval:n {\l__xhtm_sec_int + #1}}
  \seq_set_split:Nnn \l__txt_args_seq {,} {{#1},{#2},{#3}}
  \txt_use_hook:nn {xhtm} {post section header}
}

\cs_new_nopar:Npn \xhtm_num_section:nnn #1#2#3
{
  \xhtm_close_par:
  \txt_newline:
  \tl_set:Nn \l__xhtm_anchor_tl {on next}
  \refstepcounter{#1}
  \tl_set:Nn \l__xhtm_anchor_tl {plain}
  \xhtm_section_header:nnn {#2} {\use:c {the#1} \c_space_token #3} {id="\tl_use:N \l__xhtm_nextid_tl"}
\tl_gclear:N \l__xhtm_nextid_tl
  \addcontentsline{toc}{#1}{\protect\numberline{\use:c{the#1}}#3}
  \txt_newline:
  \xhtm_open_par:
}

\cs_new_nopar:Npn \xhtm_linebreak:
{
  {
    \everypar{}
    \par
    \xhtm_mbox:n {}
  }
}

\cs_new_nopar:Npn \xhtm_close_par:
{
  \xhtm_if_current_tag_is_par:T
  {
    \xhtm_close_tag:n {p}
    \xhtm_linebreak:
  }
}

\cs_new_nopar:Npn \xhtm_open_par:
{
  \xhtm_if_current_tag_is_par:F
  {
    \xhtm_linebreak:
    \xhtm_open_tag:nn {p}{}
  }
}

\cs_new_nopar:Npn \xhtm_reopen_par:
{
  \xhtm_if_current_tag_is_par:T
  {
    \xhtm_close_tag:n {p}
    \xhtm_linebreak:
    \xhtm_open_tag:nn {p}{}
  }
}

\DeclareDocumentEnvironment {abstract} {}
{
  \xhtm_close_par:
  \txt_use_hook:nn {xhtm} {pre abstract}
  \xhtm_open_tag:nn {div} {class="abstract"}
  \section*{Abstract}
  \xhtm_open_par:
}
{
  \xhtm_close_par:
  \xhtm_close_tag:n {div}
  \txt_use_hook:nn {xhtm} {post abstract}
  \xhtm_open_par:
}


\bool_new:N \l__xhtm_reopen_par_bool

\cs_new_nopar:Npn \xhtm_open_par:nn #1#2
{
  \xhtm_if_current_tag_is_par:TF
  {
    \bool_set_true:N \l__xhtm_reopen_par_bool
  }
  {
    \bool_set_false:N \l__xhtm_reopen_par_bool
  }
  \xhtm_close_par:
  \xhtm_open_tag:nn {#1}{#2}
  \group_begin:
}

\cs_new_nopar:Npn \xhtm_close_par:n #1
{
  \group_end:
  \xhtm_close_tag:n {#1}
  \bool_if:NT \l__xhtm_reopen_par_bool
  {
    \xhtm_open_par:
  }
}

\NewDocumentEnvironment {quote} {}
{
  \xhtm_open_par:
  \xhtm_open_par:nn {blockquote}{}
}
{
  \xhtm_close_par:n {blockquote}
}

\NewDocumentEnvironment {quotation} {}
{
  \xhtm_open_par:nn {blockquote}{}
  \xhtm_open_par:
}
{
  \xhtm_close_par:
  \xhtm_close_par:n {blockquote}
}

\cs_set_eq:NN \xhtm_orig_item:w \@item
\tl_new:N \l__xhtm_listitem_tl
\cs_new:Npn \xhtm_list_label:n #1 {#1}

\cs_new:Npn \xhtm_item_label:n #1
{
  \xhtm_open_par:
  \xhtm_open_tag:nn {span} {class="listlabel"}
  #1
  \xhtm_close_tag:n {span}
}

\NewDocumentEnvironment {xhtm itemize} {m}
{
  \xhtm_close_par:
  \xhtm_open_tag:nn {ul} {#1}
  \tl_set:Nn \l__xhtm_listitem_tl {li}
  \cs_set_eq:NN \xhtm_list_label:n \xhtm_item_label:n
  \cs_set_eq:NN \@item \xhtm_first_item:w
}
{
  \xhtm_close_par:
  \xhtm_close_tag:n {li}
  \xhtm_close_tag:n {ul}
  \xhtm_open_par:
}

\RenewDocumentEnvironment {itemize} {}
{
  \use:c {xhtm itemize}{}
}
{
  \use:c {end xhtm itemize}
}

\int_new:N \l__xhtm_enum_int
\NewDocumentEnvironment {xhtm enumerate} {m}
{
  \xhtm_close_par:
  \int_compare:nF {\l__xhtm_enum_int > 3}
  {
    \int_incr:N \l__xhtm_enum_int
    \exp_args:Nx \usecounter {enum \int_to_roman:n {\l__xhtm_enum_int}     }
  }
  \xhtm_open_tag:nn {ol} {#1}
  \tl_set:Nn \l__xhtm_listitem_tl {li}
  \cs_set_eq:NN \xhtm_list_label:n \xhtm_item_label:n
  \cs_set_eq:NN \@item \xhtm_first_item:w
}
{
  \xhtm_close_par:
  \xhtm_close_tag:n {li}
  \xhtm_close_tag:n {ol}
  \xhtm_open_par:
}

\RenewDocumentEnvironment {enumerate} {o}
{
  \use:c {xhtm enumerate}{}
}
{
  \use:c {end xhtm enumerate}
}

\cs_new:Npn \xhtm_desc_label:n #1
{
  \xhtm_open_tag:nn {dt} {class="listlabel"}
  #1
  \xhtm_close_tag:n {dt}
  \xhtm_open_tag:nn {dd} {}
  \xhtm_open_par:
}

\NewDocumentEnvironment {xhtm description} {m}
{
  \xhtm_close_par:
  \xhtm_open_tag:nn {dl} {}
  \txt_set_hook:nnn {xhtm} {after list item} {\xhtm_close_tag:n {dd}}
  \tl_set:Nn \l__xhtm_listitem_tl {di}
  \cs_set_eq:NN \xhtm_list_label:n \xhtm_desc_label:n
  \cs_set_eq:NN \@item \xhtm_first_item:w
}
{
  \xhtm_close_par:
  \xhtm_close_tag:n {dd}
  \xhtm_close_tag:n {di}
  \xhtm_close_tag:n {dl}
  \xhtm_open_par:
}

\DeclareDocumentEnvironment {description} {}
{
  \use:c {xhtm description}{}
}
{
  \use:c {end xhtm description}
}


\cs_new_nopar:Npn \xhtm_first_item:w [#1]
{
  \latex_if:nTF {@noitemarg}
  {
    \@noitemargfalse
    \latex_if:nTF {@nmbrlist}
    {
      \tl_set:Nn \l__xhtm_anchor_tl {on next}
      \refstepcounter\@listctr
      \xhtm_open_tag:Vn \l__xhtm_listitem_tl {id="\tl_use:N \l__xhtm_nextid_tl"}
      \tl_gclear:N \l__xhtm_nextid_tl
      \xhtm_open_par:
      \tl_set:Nn \l__xhtm_anchor_tl {plain}
    }
    {
      \xhtm_open_tag:Vn \l__xhtm_listitem_tl {}
      \xhtm_open_par:
    }
  }
  {
    \xhtm_open_tag:Vn \l__xhtm_listitem_tl {class="listlabel"}
    \xhtm_list_label:n {#1}
  }
  \cs_set_eq:NN \@item \xhtm_main_item:w
}

\cs_new_nopar:Npn \xhtm_main_item:w [#1]
{
  \xhtm_close_par:
  {
    \txt_use_hook:nn {xhtm} {after list item}
  }
  \xhtm_close_tag:V \l__xhtm_listitem_tl
  \latex_if:nTF {@noitemarg}
  {
    \@noitemargfalse
    \latex_if:nTF {@nmbrlist}
    {
      \tl_set:Nn \l__xhtm_anchor_tl {on next}
      \refstepcounter\@listctr
      \xhtm_open_tag:Vn \l__xhtm_listitem_tl {id="\tl_use:N \l__xhtm_nextid_tl"}
      \tl_gclear:N \l__xhtm_nextid_tl
      \tl_set:Nn \l__xhtm_anchor_tl {plain}
      \xhtm_open_par:
    }
    {
      \xhtm_open_tag:Vn \l__xhtm_listitem_tl {}
      \xhtm_open_par:
    }
  }
  {
    \xhtm_open_tag:Vn \l__xhtm_listitem_tl {class="listlabel"}
    \xhtm_list_label:n {#1}
  }
}

% Entity handling
\NewDocumentCommand \entity {m}
{
  \&#1;
}

\NewDocumentCommand \hexentity {m}
{
  \entity{\#x#1}
}

% Are we using unicode?  Can we test for this?
\RenewDocumentCommand \" {m} {\entity{#1uml}}
\RenewDocumentCommand \` {m} {\entity{#1grave}}
\RenewDocumentCommand \' {m} {\entity{#1acute}}
\RenewDocumentCommand \^ {m} {\entity{#1circ}}
\RenewDocumentCommand \~ {m} {\entity{#1tilde}}
\RenewDocumentCommand \c {m} {\entity{#1cedil}}
\RenewDocumentCommand \v {m} {\entity{#1caron}}
\RenewDocumentCommand \. {m} {\entity{#1dot}}
\RenewDocumentCommand \ae {} {\entity{aelig}}
\RenewDocumentCommand \AE {} {\entity{AElig}}
\RenewDocumentCommand \oe {} {\entity{oelig}}
\RenewDocumentCommand \OE {} {\entity{OElig}}
\RenewDocumentCommand \aa {} {\entity{aring}}
\RenewDocumentCommand \AA {} {\entity{Aring}}
\RenewDocumentCommand \o {} {\entity{oslash}}
\RenewDocumentCommand \O {} {\entity{Oslash}}
\RenewDocumentCommand \ss {} {\entity{szlig}}
\RenewDocumentCommand \P {} {\entity{\#182}}

\RenewDocumentCommand \TeX {} {TeX}
\RenewDocumentCommand \LaTeX {} {La\TeX}

% Should we set `\nobreakspace` directly?
\group_begin:
\char_set_catcode_active:n {126}
\AtBeginDocument{\cs_set:Npn ~ {\entity{nbsp}}}
\group_end:

% Verbatim handling ...

\RenewDocumentCommand \verb {v}
{
  \xhtm_open_tag:nn {code}{}
  #1
  \xhtm_close_tag:n {code}
}

\cs_new:Npn \xhtm_lt:
{
  \hexentity {3C}
}

\cs_new:Npn \xhtm_gt:
{
  \hexentity {3E}
}

\cs_new:Npn \xhtm_amp:
{
  \hexentity {26}
}

\cs_new:Npn \xhtm_dollar:
{
  \hexentity {24}
}

\group_begin:
\char_set_catcode_active:N <
\char_set_catcode_active:N >
\char_set_catcode_active:N &
\char_set_catcode_active:N $%$
\cs_new:Npn \xhtm_verb_entities:
{
  \char_set_catcode_active:N <
  \char_set_catcode_active:N >
  \char_set_catcode_active:N &
  \char_set_catcode_active:N $%$ should just check for itex
  \cs_set_eq:NN < \xhtm_lt:
  \cs_set_eq:NN > \xhtm_gt:
  \cs_set_eq:NN & \xhtm_amp:
  \cs_set_eq:NN $ \xhtm_dollar:%$
}
\cs_new:Npn \xhtm_set_lt:
{
  \cs_set_eq:NN < \xhtm_lt:
}

\cs_new:Npn \xhtm_set_gt:
{
  \cs_set_eq:NN > \xhtm_gt:
}
\cs_new:Npn \xhtm_set_amp:
{
  \cs_set_eq:NN & \xhtm_amp:
}

\cs_gset_eq:NN > \xhtm_gt:
\cs_gset_eq:NN < \xhtm_lt:
\cs_gset_eq:NN & \xhtm_amp:

\group_end:

\cs_set_eq:NN \xhtm_orig_endverbatim: \endverbatim

\cs_set:Npn \verbatim
{
  \xhtm_close_par:
  \xhtm_open_tag:nn {pre} {}
  \xhtm_open_tag:nn {code} {}
  \group_begin:
  \cs_set_eq:NN \@item \xhtm_orig_item:w
  \@verbatim
  \frenchspacing
  \@vobeyspaces
  \xhtm_verb_entities:
  \@xverbatim
}

\cs_set:Npn \endverbatim
{
  \xhtm_orig_endverbatim:
  \group_end:
  \xhtm_close_tag:n {code}
  \xhtm_close_tag:n {pre}
  \par
}

% Floats
\DeclareDocumentEnvironment {float} {m}
{
  \xhtm_open_tag:nn {div} {style="float: #1; display: inline; position: relative; width=50\@percentchar;"}
}
{
  \xhtm_close_tag:n {div}
}

% Graphics handling
\DeclareDocumentCommand \xhtm_includegraphics {o m}
{
  \xhtm_pre_graphics:n {#2}
  \xhtm_empty_tag:nn {img} {src="#2.png" style="max-width: 80\@percentchar; margin-left: 5\@percentchar;"}
  \xhtm_post_graphics:n {#2}
}

\cs_new_nopar:Npn \xhtm_pre_graphics:n #1 {}
\cs_new_nopar:Npn \xhtm_post_graphics:n #1 {}

\AtBeginDocument{
  \cs_if_exist:NT \includegraphics
  {
    \cs_set_eq:NN \includegraphics \xhtm_includegraphics
  }
}

% Table of contents
\NewDocumentCommand \tableofcontents {}
{
  \group_begin:
  \everypar{}
  \section*{\contentsname}
  \int_gzero_new:N \l__xhtm_toclvl_int
  \@starttoc{toc}
  \int_compare:nT {\l__xhtm_toclvl_int > 0}
  {
    \prg_replicate:nn {\l__xhtm_toclvl_int} {\endenumerate}
  }
  \group_end:
}

\tl_set:Nn \contentsname {Contents}

\DeclareDocumentCommand \numberline {m}
{
  #1. \c_space_token
}

\NewDocumentCommand \l@part {m m}
{
  \xhtm_tocline:nnn {1} {#1} {#2}
}


\NewDocumentCommand \l@chapter {m m}
{
  \xhtm_tocline:nnn {1} {#1} {#2}
}

\NewDocumentCommand \l@section {m m}
{
  \xhtm_tocline:nnn {1} {#1} {#2}
}

\NewDocumentCommand \l@subsection {m m}
{
  \xhtm_tocline:nnn {2} {#1} {#2}
}

\NewDocumentCommand \l@subsubsection {m m}
{
  \xhtm_tocline:nnn {3} {#1} {#2}
}

\NewDocumentCommand \l@paragraph {m m m} {}
\NewDocumentCommand \l@subparagraph {m m m} {}

\cs_new_nopar:Npn \xhtm_tocline:nnn #1#2#3
{
  \cs_gset_eq:NN \Hy@tocdestname \Hy@tocdestname
  \int_compare:nT {\l__xhtm_toclvl_int > #1}
  {
    \prg_replicate:nn {\l__xhtm_toclvl_int - #1} {\endenumerate}
  }
  \int_compare:nT {\l__xhtm_toclvl_int < #1}
  {
    \prg_replicate:nn {#1 - \l__xhtm_toclvl_int} {\enumerate}
  }
  \item #2
  \int_gset:Nn \l__xhtm_toclvl_int {#1}
}

% Minipage and parbox need thinking about

\cs_set:Npn \@iiiminipage #1#2[#3]#4
{
  \xhtm_close_par:
  \xhtm_open_tag:nn {div}{class="minipage"}
  \xhtm_open_par:
}
\cs_set:Npn \endminipage
{
  \xhtm_close_par:
  \xhtm_close_tag:n {div}
  \xhtm_close_par:
}

\cs_set:Npn \thepage {}
\cs_set:Npn \indexname {Index}
\cs_set:Npn \hfill {}

\RenewDocumentCommand \hspace {m} {}
\RenewDocumentCommand \\ {o} {}

\tl_new:N \l__xhtm_css_tl
\tl_new:N \l__xhtm_js_tl
\tl_new:N \l__xhtm_cssfiles_tl
\tl_new:N \l__xhtm_jsfiles_tl

\cs_new:Npn \xhtm_add_css:n #1
{
  \tl_gput_right:Nn \l__xhtm_css_tl {#1}
}

\cs_generate_variant:Nn \xhtm_add_css:n {V,x}

\NewDocumentCommand \addcss {+v}
{
  \tl_set:Nn \l_tmpa_tl {#1}
  \tl_replace_all:NVn \l_tmpa_tl \g__xhtm_newline_tl {\xhtm_linebreak:}%
  \xhtm_add_css:V \l_tmpa_tl
% Make this a test on the last token
  \xhtm_add_css:n {\txt_newline:}
}

\cs_new:Npn \xhtm_add_js:n #1
{
  \tl_gput_right:Nn \l__xhtm_js_tl {#1}
}

\cs_generate_variant:Nn \xhtm_add_js:n {V,x}

\cs_generate_variant:Nn \tl_replace_all:Nnn {NVn}

\tl_new:N \g__xhtm_newline_tl
\tl_set:Nx \g__xhtm_newline_tl { \cs_to_str:N \^^M }

\NewDocumentCommand \addjavascript {+v}
{
  \tl_set:Nn \l_tmpa_tl {#1}
  \tl_replace_all:NVn \l_tmpa_tl \g__xhtm_newline_tl {\xhtm_linebreak:}%
  \xhtm_add_js:V \l_tmpa_tl
}

\NewDocumentCommand \loadcss {m}
{
  \seq_set_split:Nnn \l__txt_args_seq {,} {{#1}}
  \txt_use_hook:nn {xhtm} {load css}
  \tl_gput_right:Nn \l__xhtm_cssfiles_tl
  {
    \xhtm_empty_tag:nn {link} {href="#1.css"~ media="all"~ rel="stylesheet"~ type="text/css"}
  }
}

\NewDocumentCommand \loadjs {m}
{
  \seq_set_split:Nnn \l__txt_args_seq {,} {{#1}}
  \txt_use_hook:nn {xhtm} {load js}
  \tl_gput_right:Nn \l__xhtm_jsfiles_tl
  {
    \xhtm_empty_tag:nn {script} {src="#1.js"~ type="text/javascript"}
  }
}

\tl_new:N \l__xhtm_declaration_tl
\tl_set:Nn \l__xhtm_declaration_tl
{
  <?xml~ version="1.0"~ encoding="UTF-8"?>
  \xhtm_linebreak:
<!DOCTYPE~ html~ PUBLIC~ "-//W3C//DTD~ XHTML~ 1.1~ plus~ MathML~ 2.0~ plus~ SVG~ 1.1//EN"~ "http://www.w3.org/2002/04/xhtml-math-svg/xhtml-math-svg.dtd"~ >
  \xhtm_open_tag:nn {html} {xmlns="http://www.w3.org/1999/xhtml"}
}

\tl_new:N \l__xhtm_begindoc_tl

\AtBeginDocument{
  \tl_use:N \l__xhtm_begindoc_tl
}

\cs_new_nopar:Npn \xhtm_at_begindocument:n #1
{
  \tl_put_right:Nn \l__xhtm_begindoc_tl {#1}
}

\tl_new:N \l__xhtm_title_tl
\tl_set_eq:NN \l__xhtm_title_tl \@title
\tl_new:N \l__xhtm_author_tl
\tl_set_eq:NN \l__xhtm_author_tl \@author

\xhtm_at_begindocument:n
{
  \tl_use:N \l__xhtm_declaration_tl
  \xhtm_open_tag:nn {head}{}
  \tl_if_eq:NNF \@title \l__xhtm_title_tl
  {
    \xhtm_linebreak:
    \xhtm_open_tag:nn {title}{}
    \@title
    \xhtm_close_tag:n {title}
  }
  \tl_if_eq:NNF \@author \l__xhtm_author_tl
  {
    \xhtm_linebreak:
    \xhtm_empty_tag:nn {meta} {name="Author" content="\@author"}
  }
  \tl_use:N \l__xhtm_cssfiles_tl
  \tl_if_empty:NF \l__xhtm_css_tl
  {
    \xhtm_linebreak:
    \xhtm_open_tag:nn {style} {type="text/css"}
    \xhtm_linebreak:
    \tl_use:N \l__xhtm_css_tl
    \xhtm_linebreak:
    \xhtm_close_tag:n {style}
    \xhtm_linebreak:
  }
  \tl_use:N \l__xhtm_jsfiles_tl
  \tl_if_empty:NF \l__xhtm_js_tl
  {
    \xhtm_linebreak:
    \xhtm_open_tag:nn {script} {type="text/javascript"}
    \xhtm_linebreak:
    //<![CDATA[
        \xhtm_linebreak:
        \tl_use:N \l__xhtm_js_tl
        \xhtm_linebreak:
        //]]>
    \xhtm_linebreak:
    \xhtm_close_tag:n {script}
    \xhtm_linebreak:
  }
  \xhtm_close_tag:n {head}
  \xhtm_open_tag:nn {body} {}
  \xhtm_open_par:
  \everypar{\xhtm_reopen_par:}
}

\cs_set:Npn \@doendpe
{
  \@endpetrue
  \cs_set:Npn \par
  {
    \@restorepar
    \everypar{\xhtm_reopen_par:}
    \par
    \@endpefalse
  }
  \everypar{{\setbox\z@\lastbox}\everypar{}\@endpefalse}
}

\tl_new:N \l__xhtm_enddoc_tl

\tl_put_left:Nn \@enddocumenthook
{
  \tl_use:N \l__xhtm_enddoc_tl
}

\cs_new_nopar:Npn \xhtm_at_enddocument:n #1
{
  \tl_put_right:Nn \l__xhtm_enddoc_tl {#1}
}

% Theorems ...

\RenewDocumentCommand \newtheorem {s m o m o}
{
  \IfBooleanTF {#1}
  {
    % Starred form, so no numbers
    \xhtm_define_theorem:nnn {#2} {#4} {}
  }
  {
    % Non-starred form, so numbered
    % Was there a third argument?
    \IfValueTF {#3}
    {
      % Yes, so we reuse this counter
      \xhtm_define_theorem:nnn {#2} {#4} {#3}
    }
    {
      % No, so define a new counter
      % Did we get a fifth argument?
      \IfValueTF {#5}
      {
        % Yes, so the new counter steps with the fifth
        \newcounter{#2}[#5]
        \cs_set:cpx {the #2} {\exp_not:c {the #5} \@thmcountersep \@thmcounter{#2}}
      }
      {
        % No, just a new counter
        \newcounter{#2}
      }
      \xhtm_define_theorem:nnn {#2} {#4} {#2}
    }
  }
}

\tl_new:N \l__xhtm_theoremstyle_tl
\tl_new:N \l__xhtm_ctheoremstyle_tl
\tl_set:Nn \l__xhtm_theoremstyle_tl {plain}
\bool_new:N \l__xhtm_swaphead_bool

\cs_generate_variant:Nn \cs_set_nopar:Nn {NV}
% Theorem definer
\cs_new_nopar:Npn \xhtm_define_theorem:nnn #1#2#3
{
  \tl_clear:N \l_tmpa_tl
  \tl_put_right:Nx \l_tmpa_tl
  {
    \exp_not:c {xhtm theorem}
    { \exp_not:N \tl_set:Nn \exp_not:N \l__xhtm_ctheoremstyle_tl
      {\l__xhtm_theoremstyle_tl}
      \bool_if:NTF \l__xhtm_swaphead_bool
      {
        \exp_not:N \bool_set_true:N
      }
      {
        \exp_not:N \bool_set_false:N
      }
      \exp_not:N \l__xhtm_swaphead_bool
    }
  }
  \tl_put_right:Nn \l_tmpa_tl {{#2}{#3}}
  \cs_set_nopar:NV \xhtm_tmp_thm: \l_tmpa_tl
  \cs_set_eq:cN {#1} \xhtm_tmp_thm:
  \cs_set_eq:cc {end #1} {end xhtm theorem}
}

\DeclareDocumentEnvironment {xhtm theorem} {m m m O{}}
{
  #1
  \tl_gclear:N \l__xhtm_anchor_tl
  \tl_gclear:N \l__xhtm_nextid_tl
  \tl_if_empty:nF {#3}
  {
    \tl_set:Nn \l__xhtm_anchor_tl {on next}
    \refstepcounter{#3}
    \tl_set:Nn \l__xhtm_anchor_tl {plain}
  }
  \xhtm_close_par:
  \tl_if_empty:NTF \l__xhtm_nextid_tl
  {
    \xhtm_open_tag:nn {div} {class="gentheorem~ \tl_use:N \l__xhtm_ctheoremstyle_tl"}
  }
  {
    \xhtm_open_tag:nn {div} {class="gentheorem~ \tl_use:N \l__xhtm_ctheoremstyle_tl"~ id="\tl_use:N \l__xhtm_nextid_tl"}
    \tl_gclear:N \l__xhtm_nextid_tl
  }
  \xhtm_open_tag:nn {span} {class="title"}
  \tl_if_empty:nTF {#3}
  {
    \bool_if:NTF \l__xhtm_swaphead_bool
    {
      \xhtm_theorem_swaphead:nnn {#2} {} {#4}
    }
    {
      \xhtm_theorem_plainhead:nnn {#2} {} {#4}
    }
  }
  {
    \bool_if:NTF \l__xhtm_swaphead_bool
    {
      \xhtm_theorem_swaphead:nnn {#2} {\use:c{the #3}} {#4}
    }
    {
      \xhtm_theorem_plainhead:nnn {#2} {\use:c{the #3}} {#4}
    }
  }
  \xhtm_close_tag:n {span}
  \xhtm_open_par:
}
{
  \xhtm_close_par:
  \xhtm_close_tag:n {div}
  \xhtm_open_par:
}

\cs_new_nopar:Npn \xhtm_theorem_plainhead:nnn #1#2#3
{
  \tl_if_empty:nF {#1}
  {
    \xhtm_open_tag:nn {span} {class="name"}
    #1
    \xhtm_close_tag:n {span}
  }
  \tl_if_empty:nF {#2}
  {
    \tl_if_empty:nF {#1} {\c_space_token}
    \xhtm_open_tag:nn {span} {class="number"}
    #2
    \xhtm_close_tag:n {span}
  }
  \tl_if_empty:nF {#3}
  {
    \c_space_token
    \xhtm_open_tag:nn {span} {class="note"}
    #3
    \xhtm_close_tag:n {span}
  }
}

\cs_new_nopar:Npn \xhtm_theorem_swaphead:nnn #1#2#3
{
  \tl_if_empty:nF {#2}
  {
    \xhtm_open_tag:nn {span} {class="number"}
    #2
    \xhtm_close_tag:n {span}
  }
  \tl_if_empty:nF {#1}
  {
    \tl_if_empty:nF {#2} {\c_space_token}
    \xhtm_open_tag:nn {span} {class="name"}
    #1
    \xhtm_close_tag:n {span}
  }
  \tl_if_empty:nF {#3}
  {
    \c_space_token
    \xhtm_open_tag:nn {span} {class="note"}
    #3
    \xhtm_close_tag:n {span}
  }
}

\DeclareDocumentCommand \theoremstyle {m}
{
  \tl_set:Nx \l__xhtm_theoremstyle_tl {#1}
}

\DeclareDocumentCommand \newtheoremstyle {mmmmmmmmm}
{
  \tl_clear:N \l_tmpa_tl
  \tl_if_empty:nF {#2}
  {
    \tl_put_right:Nn \l_tmpa_tl {margin-top:~ #2;~}
  }
  \tl_if_empty:nF {#3}
  {
    \tl_put_right:Nn \l_tmpa_tl {margin-bottom:~ #3;~}
  }
  \tl_if_empty:nF {#5}
  {
    \tl_put_right:Nn \l_tmpa_tl {margin-left:~ #5;~}
  }
  \tl_if_empty:NF \l_tmpa_tl
  {
    \tl_put_right:Nx \l__xhtm_css_tl
    {
      div.gentheorem.#1~ \txt_lbrace: \tl_use:N \l_tmpa_tl \txt_rbrace:
    }
  }
  \tl_clear:N \l_tmpa_tl
  \tl_if_empty:nF {#4}
  {
    \tl_set:Nx \l_tmpb_tl {\tl_head:n {#4}}
    \tl_if_eq:VnT \l_tmpb_tl {\itshape}
    {
      \tl_put_right:Nn \l_tmpa_tl {font-style:~ italic;~}
      \tl_put_right:Nx \l__xhtm_css_tl
      {
        div.gentheorem.#1~ em \txt_lbrace: font-style:~ normal; \txt_rbrace:
      }
    }
    \tl_if_eq:VnT \l_tmpb_tl {\bfseries}
    {
      \tl_put_right:Nn \l_tmpa_tl {font-weight:~ bold;~}
    }
  }
  \tl_if_empty:NF \l_tmpa_tl
  {
    \tl_put_right:Nx \l__xhtm_css_tl
    {
      .gentheorem.#1~ \txt_lbrace: \tl_use:N \l_tmpa_tl \txt_rbrace:
    }
  }
  \tl_clear:N \l_tmpa_tl
  \tl_if_empty:nF {#6}
  {
    \tl_set:Nx \l_tmpb_tl {\tl_head:n {#6}}
    \tl_if_eq:VnT \l_tmpb_tl {\itshape}
    {
      \tl_put_right:Nn \l_tmpa_tl {font-style:~ italic;~}
    }
    \tl_if_eq:VnT \l_tmpb_tl {\bfseries}
    {
      \tl_put_right:Nn \l_tmpa_tl {font-weight:~ bold;~}
    }
  }
  \tl_if_empty:nF {#8}
  {
    \tl_put_right:Nn \l_tmpa_tl {margin-right:~ #8;~}
  }
  \tl_if_empty:NF \l_tmpa_tl
  {
    \tl_put_right:Nx \l__xhtm_css_tl
    {
      .gentheorem.#1~ .title~ \txt_lbrace: \tl_use:N \l_tmpa_tl \txt_rbrace:
    }
  }
  \tl_if_empty:nF {#7}
  {
    \tl_put_right:Nx \l__xhtm_css_tl
    {
      .gentheorem.#1~ .title:after~ \txt_lbrace: content:~ #7; \txt_rbrace:
    }
  }
}

\DeclareDocumentCommand \swapnumbers {}
{
  \bool_set:Nn  \l__xhtm_swaphead_bool { !\l__xhtm_swaphead_bool }
}

\NewDocumentCommand \numberwithin {O{\arabic} m m}
{
  \cs_if_exist:cTF {c@#2}
  {
    \cs_if_exist:cTF {c@#3}
    {
      \@addtoreset{#2}{#3}
      \cs_set:cpx {the #2} {\exp_not:c {the #3} . \exp_not:N #1 {#2}}
    }
    {
      \@nocountererr{#3}
    }
  }
  {
    \@nocountererr{#2}
  }
}

\tl_new:N \l__xhtm_proof_attr_tl
\NewDocumentEnvironment {proof} {O{Proof}}
{
  \xhtm_close_par:
  \xhtm_open_tag:nn {div} {class="proof" \tl_use:N \l__xhtm_proof_attr_tl}
  \xhtm_open_tag:nn {span} {class="title"}
  #1
  \xhtm_close_tag:n {span}
  {
    \txt_use_hook:nn {xhtm} {after~ proof~ title}
  }
  \xhtm_open_tag:nn {div} {class="body"}
  \xhtm_open_par:
}
{
  \xhtm_close_par:
  \xhtm_close_tag:n {div}
  \xhtm_close_tag:n {div}
  \xhtm_open_par:
}

% Maths

\tl_new:N \l__xhtm_mathtype_tl

\tl_new:N \l__xhtm_beginmaths_tl
\tl_set:Nn \l__xhtm_beginmaths_tl
{
  \bool_if:nT
  {
    \l__itex_display_bool && \l__itex_numbered_bool
  }
  {
    \tl_set:Nn \l__xhtm_anchor_tl {on next}
  }
}

\tl_new:N \l__xhtm_begindisplay_tl
\tl_set:Nn \l__xhtm_begindisplay_tl
{
  \xhtm_close_par:
  \xhtm_linebreak:
  \tl_if_empty:NTF \l__xhtm_mathtype_tl
  {
    \xhtm_open_tag:nn {table} {class="displaymaths\bool_if:NT \l__itex_numbered_bool {~numbered}"}
  }
  {
    \xhtm_open_tag:nn {table} {class="displaymaths\bool_if:NT \l__itex_numbered_bool {~numbered}~ \tl_use:N \l__xhtm_mathtype_tl"}
  }
  \xhtm_open_tag:nn {tr} {}
  \xhtm_open_tag:nn {td} {class="label"}
  \xhtm_close_tag:n {td}
  \xhtm_open_tag:nn {td} {class="maths"}
  \tl_gclear:N \l__xhtm_eqnnums_tl
  \bool_set_true:N \l__xhtm_next_num_bool
}

\tl_new:N \l__xhtm_enddisplay_tl
\tl_set:Nn \l__xhtm_enddisplay_tl
{
  \bool_if:NT \l__itex_numbered_bool
  {
    \tl_gput_right:Nx \l__xhtm_eqnnums_tl
    {
      \exp_not:N \xhtm_open_tag:nn {tr} {class="eqnnumber"}
      \exp_not:N \xhtm_open_tag:nn {td} {}
      \bool_if:NT \l__xhtm_next_num_bool
      {
        \exp_not:N \xhtm_open_tag:nn {span} {class="eqnnumber"~           id="\tl_use:N \l__xhtm_nextid_tl"}
        \theequation
        \exp_not:N \xhtm_close_tag:n {span}
      }
      \exp_not:N \xhtm_close_tag:n {td}
      \exp_not:N \xhtm_close_tag:n {tr}
      \exp_not:N \xhtm_linebreak:
    }
    \tl_gclear:N \l__xhtm_nextid_tl
  }
  \xhtm_close_par:
  \xhtm_close_tag:n {td}
  \xhtm_open_tag:nn {td} {class="label"}
  \tl_if_empty:NF \l__xhtm_eqnnums_tl
  {
    \xhtm_open_tag:nn {table} {}
    \tl_use:N \l__xhtm_eqnnums_tl
    \xhtm_close_tag:n {table}
    \tl_gclear:N \l__xhtm_eqnnums_tl
  }
  \xhtm_close_tag:n {td}
  \xhtm_close_tag:n {tr}
  \xhtm_close_tag:n {table}
  \xhtm_linebreak:
  \xhtm_open_par:
}

\bool_new:N \l__xhtm_next_num_bool
\tl_new:N \l__xhtm_eqnnums_tl
\tl_new:N \l__xhtm_beginalign_tl
\tl_set:Nn \l__xhtm_beginalign_tl
{
  \tl_set:Nn \l__xhtm_mathtype_tl {align}
  \bool_if:NT \l__itex_numbered_bool
  {
    \cs_set_eq:NN \xhtm_itexnl: \itexnl
    \cs_set:Npn \nonumber
    {
      \bool_set_false:N \l__xhtm_next_num_bool
    }
    \txt_set_hook:nnn {cmd} {matrix} {\cs_set_eq:NN \\ \xhtm_itexnl:}
    \txt_set_hook:nnn {cmd} {pmatrix} {\cs_set_eq:NN \\ \xhtm_itexnl:}
    \txt_set_hook:nnn {cmd} {bmatrix} {\cs_set_eq:NN \\ \xhtm_itexnl:}
    \txt_set_hook:nnn {cmd} {vmatrix} {\cs_set_eq:NN \\ \xhtm_itexnl:}
    \txt_set_hook:nnn {cmd} {Bmatrix} {\cs_set_eq:NN \\ \xhtm_itexnl:}
    \txt_set_hook:nnn {cmd} {Vmatrix} {\cs_set_eq:NN \\ \xhtm_itexnl:}
    \txt_set_hook:nnn {cmd} {smallmatrix} {\cs_set_eq:NN \\ \xhtm_itexnl:}
    \cs_set:Npn \itexnl
    {
      \tl_if_empty:NF \l__xhtm_nextid_tl
      {
        \tl_gput_right:Nx \l__xhtm_eqnnums_tl
        {
          \exp_not:N \xhtm_open_tag:nn {tr} {class="eqnnumber"}
          \exp_not:N \xhtm_open_tag:nn {td} {}
          \bool_if:NT \l__xhtm_next_num_bool
          {
            \exp_not:N \xhtm_open_tag:nn {span} {class="eqnnumber"~ id="\tl_use:N \l__xhtm_nextid_tl"}
            \theequation
            \exp_not:N \xhtm_close_tag:n {span}
          }
          \exp_not:N \xhtm_close_tag:n {td}
          \exp_not:N \xhtm_close_tag:n {tr}
          \exp_not:N \xhtm_linebreak:
        }
      }
      \xhtm_itexnl:
      \xhtm_linebreak:
      \bool_if:NT \l__xhtm_next_num_bool
      {
        \tl_set:Nn \l__xhtm_anchor_tl {on next}
        \refstepcounter{equation}
      }
      \bool_set_true:N \l__xhtm_next_num_bool
    }
  }
}


\txt_addto_hook:nnn {itex} {begin maths} {\tl_use:N \l__xhtm_beginmaths_tl}
\txt_addto_hook:nnn {itex} {begin display} {\tl_use:N \l__xhtm_begindisplay_tl}
\txt_addto_hook:nnn {itex} {end display} {\tl_use:N \l__xhtm_enddisplay_tl}
\txt_addto_hook:nnn {itex} {begin align} {\tl_use:N \l__xhtm_beginalign_tl}
\txt_addto_hook:nnn {itex} {begin gather} {\tl_use:N \l__xhtm_beginalign_tl}


% Bibliography ...

\tl_set:Nn \bibname {Bibliography}

\NewDocumentEnvironment {thebibliography} {m}
{
  \seq_set_split:Nnn \l__txt_args_seq {,} {{#1}}
  \txt_use_hook:nn {xhtm} {pre bibliography header}
  \section*{References}
  \seq_set_split:Nnn \l__txt_args_seq {,} {{#1}}
  \txt_use_hook:nn {xhtm} {post bibliography header}
  \use:c{xhtm enumerate}{class="bibliography"}
}
{
  \use:c{end xhtm enumerate}
}

\cs_set_eq:NN \newblock \relax


% Some general user commands

\NewDocumentCommand \addattribute {m m}
{
  \tl_if_exist:cTF {l__xhtm_#1_attr_tl}
  {
    \tl_put_right:cn {l__xhtm_#1_attr_tl} {\c_space_token #2}
  }
  {
    \tl_new:c {l__xhtm_#1_attr_tl}
    \tl_set:cn {l__xhtm_#1_attr_tl} {#2}
  }
}

\NewDocumentCommand \xhtmtag {m m m}
{
  \xhtm_open_tag:nn {#1}{#2}
  #3
  \xhtm_close_tag:n {#1}
}

\cs_new_nopar:Npn \xhtm_comment:n #1
{
  \xhtm_linebreak:
  <!-{}-~ #1~ -{}->
  \xhtm_linebreak:
}

\NewDocumentCommand \xhtmcomment {m}
{
  \xhtm_comment:n {#1}
}

\NewDocumentEnvironment {xhtmdiv} {m}
{
  \xhtm_close_par:
  \xhtm_open_tag:nn {div} {class="#1"}
  \xhtm_open_par:
}
{
  \xhtm_close_par:
  \xhtm_close_tag:n {div}
  \xhtm_open_par:
}

\cs_set:Npn \maketitle {}

\DeclareDocumentEnvironment {center} {}
{
  \xhtm_close_par:
  \xhtm_open_tag:nn {div} {class="center"}
  \xhtm_open_par:
}
{
  \xhtm_close_par:
  \xhtm_close_tag:n {div}
  \xhtm_open_par:
}

% Footnotes, collect together and then typset at the end.

\tl_new:N \l__xhtm_footnote_tl
\int_new:N \l__xhtm_footnote_int

\DeclareDocumentCommand \footnote {m}
{
  \xhtm_add_footnote:n {#1}
}

\cs_new:Npn \xhtm_add_footnote:n #1
{
  \int_gincr:N \l__xhtm_footnote_int
  \xhtm_open_tag:nx {a}
  {
    class="footnote_src"~
    id="footnote_src.\int_use:N \l__xhtm_footnote_int"~
    href="\#footnote_tgt.\int_use:N \l__xhtm_footnote_int"
  }
  \int_use:N \l__xhtm_footnote_int
  \xhtm_close_tag:n {a}
  \tl_if_empty:NF \l__xhtm_footnote_tl
  {
    \tl_gput_right:Nn \l__xhtm_footnote_tl
    {
      \xhtm_empty_tag:nn {br} {}
      \xhtm_linebreak:
    }
  }
  \tl_gput_right:Nn \l__xhtm_footnote_tl
  {
    \xhtm_open_tag:nn {a}
  }
  \tl_gput_right:Nx \l__xhtm_footnote_tl
  {
    {
      class="footnote_tgt"~
      id="footnote_tgt.\int_use:N \l__xhtm_footnote_int"~
      href="\#footnote_src.\int_use:N \l__xhtm_footnote_int"
    }
    \int_use:N \l__xhtm_footnote_int
  }
  \tl_gput_right:Nn \l__xhtm_footnote_tl
  {
    \xhtm_close_tag:n {a}
    #1
  }
}

\cs_new:Npn \xhtm_set_footnotes:
{
  \tl_if_empty:NF \l__xhtm_footnote_tl
  {
    \xhtm_open_tag:nn {div} {class="footnotes"}
    \xhtm_open_par:
    \tl_use:N \l__xhtm_footnote_tl
    \xhtm_close_par:
    \xhtm_close_tag:n {div}
  }
  \int_gzero:N \l__xhtm_footnote_int
  \tl_gclear:N \l__xhtm_footnote_tl
}

\xhtm_at_enddocument:n
{
  \xhtm_close_par:
  \xhtm_set_footnotes:
  \xhtm_close_tag:n {body}
  \xhtm_close_tag:n {html}
}

% Figures
\newcounter{figure}
\tl_set:Nn \ext@figure {lof}
\cs_new:Npn \fnum@figure {\figurename\nobreakspace\thefigure}
\tl_set:Nn \figurename {Figure}

\DeclareDocumentEnvironment {figure} {}
{
  \xhtm_close_par:
  \xhtm_open_tag:nn {div} {class="figure"}
  \xhtm_open_par:
  \tl_set:Nn \@captype {figure}
}
{
  \xhtm_close_par:
  \xhtm_close_tag:n {div}
  \xhtm_open_par:
}

\newcounter{table}
\tl_set:Nn \ext@table {lot}
\cs_new:Npn \fnum@table {\tablename\nobreakspace\thetable}
\tl_set:Nn \tablename {Table}
\DeclareDocumentEnvironment {table} {o}
{
  \xhtm_close_par:
  \xhtm_open_tag:nn {div} {class="table"}
  \xhtm_open_par:
  \tl_set:Nn \@captype {table}
}
{
  \xhtm_close_par:
  \xhtm_close_tag:n {div}
  \xhtm_open_par:
}

\cs_new:Npn \xhtm_makecaption:nn #1#2
{
  \xhtm_close_par:
  \xhtm_open_par:
  \xhtm_open_tag:nn {span} {class="caption"}
  #1: #2
  \xhtm_close_tag:n {span}
  \xhtm_close_par:
  \xhtm_open_par:
}

\cs_set_eq:NN \@makecaption \xhtm_makecaption:nn


% Tabular support

\tl_new:N \l__xhtm_tablerow_tl
\tl_new:N \l__xhtm_tablecell_tl


\DeclareDocumentEnvironment {tabular} {o m}
{
  \xhtm_close_par:
  \xhtm_open_tag:nn {table} {class="tabular"}
  \cs_set_eq:NN \\ \xhtm_table_rowsep:
  \char_set_catcode_active:N &
  \xhtm_table_setamp:
  \cs_set_eq:NN \multicolumn \xhtm_table_multicolumn:nn
  \cs_set_eq:NN \hline \xhtm_table_hline:
  \cs_set_eq:NN \toprule \xhtm_table_toprule:
  \cs_set_eq:NN \midrule \xhtm_table_midrule:
  \cs_set_eq:NN \bottomrule \xhtm_table_bottomrule:
  \cs_set_eq:NN \addlinespace \xhtm_table_addlinespace:
  \xhtm_table_startrow:
}
{
  \xhtm_close_par:
  \xhtm_close_tag:n {td}
  \xhtm_close_tag:n {tr}
  \xhtm_close_tag:n {table}
  \xhtm_open_par:
}

\group_begin:
\char_set_catcode_active:N &
\cs_new:Npn \xhtm_table_setamp:
{
  \cs_set_eq:NN & \xhtm_table_cellsep:
}
\group_end:

\cs_new:Npn \xhtm_table_cellsep:
{
  \xhtm_close_par:
  \xhtm_close_tag:n {td}
  \xhtm_linebreak:
  \xhtm_table_startcell:
}

\cs_new:Npn \xhtm_table_rowsep:
{
  \xhtm_close_par:
  \xhtm_close_tag:n {td}
  \xhtm_close_tag:n {tr}
  \xhtm_linebreak:
  \tl_clear:N \l__xhtm_tablerow_tl
  \xhtm_table_startrow:
}

\cs_new:Npn \xhtm_table_hline:
{
  \tl_if_empty:NF \l__xhtm_tablerow_tl
  {
    \tl_put_right:Nn \l__xhtm_tablerow_tl {~}
  }
  \tl_put_right:Nn \l__xhtm_tablerow_tl {class="hline"}
  \xhtm_table_startrow:
}

\cs_new:Npn \xhtm_table_toprule:
{
  \tl_if_empty:NF \l__xhtm_tablerow_tl
  {
    \tl_put_right:Nn \l__xhtm_tablerow_tl {~}
  }
  \tl_put_right:Nn \l__xhtm_tablerow_tl {class="toprule"}
  \xhtm_table_startrow:
}

\cs_new:Npn \xhtm_table_midrule:
{
  \tl_if_empty:NF \l__xhtm_tablerow_tl
  {
    \tl_put_right:Nn \l__xhtm_tablerow_tl {~}
  }
  \tl_put_right:Nn \l__xhtm_tablerow_tl {class="midrule"}
  \xhtm_table_startrow:
}

\cs_new:Npn \xhtm_table_bottomrule:
{
  \tl_if_empty:NF \l__xhtm_tablerow_tl
  {
    \tl_put_right:Nn \l__xhtm_tablerow_tl {~}
  }
  \tl_put_right:Nn \l__xhtm_tablerow_tl {class="bottomrule"}
  \xhtm_table_startrow:
}

\cs_new:Npn \xhtm_table_addlinespace:
{
  \peek_charcode_ignore_spaces:NTF [%]
    {
      \xhtm_table_addlinespace_aux:w
    }
    {
      \xhtm_table_addlinespace_aux:w []
    }
}

\cs_new:Npn \xhtm_table_addlinespace_aux:w [#1]
{
  \tl_if_empty:nF {#1}
  {
    \tl_if_empty:NF \l__xhtm_tablerow_tl
    {
      \tl_put_right:Nn \l__xhtm_tablerow_tl {~}
    }
    \tl_put_right:Nn \l__xhtm_tablerow_tl {style="padding-bottom:~ #1;"}
  }
  \xhtm_table_startrow:
}

\cs_new:Npn \xhtm_table_startrow:
{
  \peek_after:Nw \xhtm_table_testrow:
}

\cs_new:Npn \xhtm_table_testrow:
{
  \token_if_eq_meaning:NNTF \l_peek_token \c_space_token
  {
    \xhtm_table_testrow_aux:
  }
  {
    \token_if_eq_meaning:NNF \l_peek_token \xhtm_table_hline:
    {
      \token_if_eq_meaning:NNF \l_peek_token \xhtm_table_bottomrule:
      {
        \token_if_eq_meaning:NNF \l_peek_token \xhtm_table_midrule:
        {
          \token_if_eq_meaning:NNF \l_peek_token \xhtm_table_toprule:
          {
            \token_if_eq_meaning:NNF \l_peek_token \xhtm_table_addlinespace:
            {
              \xhtm_table_startrow_aux:
            }
          }
        }
      }
    }
  }
}

\cs_new_protected_nopar:Npn \xhtm_table_testrow_aux:
{
  \if_meaning:w \l_peek_token \c_space_token
    \exp_after:wN \peek_after:Nw
    \exp_after:wN \xhtm_table_testrow_aux:
    \tex_romannumeral:D -`0
  \else:
    \exp_after:wN \xhtm_table_testrow:
  \fi:
}

\cs_new:Npn \xhtm_table_startrow_aux:
{
  \xhtm_open_tag:nV {tr} \l__xhtm_tablerow_tl
  \xhtm_table_startcell:
}

\cs_new:Npn \xhtm_table_startcell:
{
  \tl_clear:N \l__xhtm_tablecell_tl
  \peek_after:Nw \xhtm_table_testcell:
}

\cs_new:Npn \xhtm_table_testcell:
{
  \token_if_eq_meaning:NNTF \l_peek_token \c_space_token
  {
    \xhtm_table_testcell_aux:
  }
  {
    \token_if_eq_meaning:NNF \l_peek_token \xhtm_table_multicolumn:nn
    {
      \xhtm_table_startcell_aux:
    }
  }
}

\cs_new_protected_nopar:Npn \xhtm_table_testcell_aux:
{
  \if_meaning:w \l_peek_token \c_space_token
    \exp_after:wN \peek_after:Nw
    \exp_after:wN \xhtm_table_testcell_aux:
    \tex_romannumeral:D -`0
  \else:
    \exp_after:wN \xhtm_table_testcell:
  \fi:
}

\cs_new:Npn \xhtm_table_startcell_aux:
{
  \xhtm_open_tag:nV {td} \l__xhtm_tablecell_tl
}

\cs_new:Npn \xhtm_table_multicolumn:nn #1#2
{
  \tl_set:Nn \l__xhtm_tablecell_tl {colspan="#1"}
  \tl_if_in:nnT {c} {#2}
  {
    \tl_put_right:Nn \l__xhtm_tablecell_tl {~ style="text-align: center;"}
  }
  \tl_if_in:nnT {r} {#2}
  {
    \tl_put_right:Nn \l__xhtm_tablecell_tl {~ style="text-align: right;"}
  }
  \xhtm_table_startcell_aux:
}

% Indexing

% \item is level 0
% \subitem is level 1
% \subsubitem is level 2
% \indexspace starts a new list

\cs_new:Npn \xhtm_index_item:
{
  \prg_replicate:nn {\l__xhtm_index_lvl_int} {\use:c {end xhtm itemize}}
  \xhtm_orig_item:
  \int_gset:Nn \l__xhtm_index_lvl_int {0}
}

\cs_new:Npn \xhtm_index_subitem:
{
  \int_compare:nT {\l__xhtm_index_lvl_int > 1}
  {
    \prg_replicate:nn {\l__xhtm_index_lvl_int - 1} {\use:c {end xhtm itemize}}
  }
  \int_compare:nT {\l__xhtm_index_lvl_int == 0}
  {
    \use:c {xhtm itemize} {class="index~ subitem"}
  }
  \xhtm_orig_item:
  \int_gset:Nn \l__xhtm_index_lvl_int {1}
}

\cs_new:Npn \xhtm_index_subsubitem:
{
  \int_compare:nT {\l__xhtm_index_lvl_int > 2}
  {
    \prg_replicate:nn {\l__xhtm_index_lvl_int - 2} {\use:c {end xhtm itemize}}
  }
  \int_compare:nT {\l__xhtm_index_lvl_int == 0}
  {
    \use:c {xhtm itemize} {class="index~ subitem"}
    \use:c {xhtm itemize} {class="index~ subsubitem"}
  }
  \int_compare:nT {\l__xhtm_index_lvl_int == 1}
  {
    \use:c {xhtm itemize} {class="index~ subitem"}
  }
  \xhtm_orig_item:
  \int_gset:Nn \l__xhtm_index_lvl_int {2}
}

\cs_new:Npn \xhtm_index_space:
{
  \prg_replicate:nn {\l__xhtm_index_lvl_int + 1} {\use:c {end xhtm itemize}}
  \use:c {xhtm itemize}{class="index"}
  \int_gset:Nn \l__xhtm_index_lvl_int {0}
}



\int_new:N \l__xhtm_index_lvl_int

\NewDocumentEnvironment{theindex} {}
{
  \use:c {xhtm itemize}{class="index"}
  \cs_set_eq:NN \xhtm_orig_item: \item
  \cs_set_eq:NN \item \xhtm_index_item:
  \cs_set_eq:NN \subitem \xhtm_index_subitem:
  \cs_set_eq:NN \subsubitem \xhtm_index_subsubitem:
  \cs_set_eq:NN \indexspace \xhtm_index_space:
  \txt_preaddto_hook:nnn {xhtm} {link} {
    \tl_set:Nx \l_tmpa_tl {\seq_item:Nn \l__txt_args_seq {2}}
    \tl_if_in:NnT \l_tmpa_tl {page.}
    {
      \tl_replace_once:Nnn \l_tmpa_tl {page.} {indexanchor.}
      \seq_clear:N \l_tmpa_seq
      \seq_pop:NN \l__txt_args_seq \l_tmpb_tl 
      \seq_push:NV \l_tmpa_seq \l_tmpa_tl
      \seq_push:NV \l_tmpa_seq \l_tmpb_tl
      \seq_pop:NN \l__txt_args_seq \l_tmpb_tl
      \seq_concat:NNN \l__txt_args_seq \l_tmpa_seq \l__txt_args_seq
    }
  }
  \int_gset:Nn \l__xhtm_index_lvl_int {0}
}
{
  \prg_replicate:nn {\l__xhtm_index_lvl_int + 1}
  {
    \use:c {end xhtm itemize}
  }
}

\int_new:N \l__xhtm_index_int
\cs_new:Npn \theindexanchor {\int_use:N \l__xhtm_index_int}

\cs_set:Npn \xhtm_index:n #1
{
  \group_begin:
  \int_gincr:N \l__xhtm_index_int
  \hyper@makecurrent{indexanchor}
  \label{indexanchor. \int_use:N \l__xhtm_index_int}
  \hyper@anchorstart{\@currentHref}\hyper@anchorend
  \group_end:
  \xhtm_orig_index:n {#1}
}

\cs_set:Npn \xhtm_write_index:n #1
{
  \cs_set:Npn \thepage {\int_use:N \l__xhtm_index_int}
  \cs_set_eq:NN \protected@write \xhtm_semiprotected_write:nnn
  \xhtm_orig_wrindex:n {#1}
}

\cs_new:Npn \xhtm_semiprotected_write:nnn #1#2#3
{
  \group_begin:
  #2%
  \cs_set_eq:NN \protect \@unexpandable@protect
  \tl_set:Nx \reserved@a {\write #1 {#3}}
  \reserved@a
  \group_end:
  \if@nobreak\ifvmode\nobreak\fi\fi
}

\AtBeginDocument{
  \cs_gset_eq:NN \xhtm_orig_index:n \index
  \cs_gset_eq:NN \index \xhtm_index:n
  \cs_gset_eq:NN \xhtm_orig_wrindex:n \@wrindex
  \cs_gset_eq:NN \@wrindex \xhtm_write_index:n
}

\endinput

% Local Variables:
% mode: latex3
% End: